> **æ³¨æ„ï¼šæœ¬é¡¹ç›®ä½¿ç”¨åŸå§‹ API æ„å»º Agentï¼Œä»…ä¾›å­¦ä¹ åŸç†ä½¿ç”¨ï¼ŒåŠŸèƒ½ä¸å®Œå–„ã€‚å®é™…é¡¹ç›®è¯·ä½¿ç”¨å®˜æ–¹ SDKï¼š[Anthropic Python SDK](https://github.com/anthropics/anthropic-sdk-python)**

# æ¥å£è‡ªåŠ¨åŒ–æµ‹è¯• Agent

åŸºäº Claude API æ„å»ºçš„æ™ºèƒ½æ¥å£è‡ªåŠ¨åŒ–æµ‹è¯• Agentï¼Œèƒ½å¤Ÿè‡ªåŠ¨è¯»å– Swagger æ–‡æ¡£ã€ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹ã€æ‰§è¡Œæµ‹è¯•å¹¶è‡ªåŠ¨ä¿®å¤é”™è¯¯ã€‚

## ç›®å½•

- [ä»€ä¹ˆæ˜¯ Agent](#ä»€ä¹ˆæ˜¯-agent)
- [é¡¹ç›®ç»“æ„](#é¡¹ç›®ç»“æ„)
- [å¿«é€Ÿå¼€å§‹](#å¿«é€Ÿå¼€å§‹)
- [ä½¿ç”¨æ–¹æ³•](#ä½¿ç”¨æ–¹æ³•)
- [æ ¸å¿ƒåŸç†](#æ ¸å¿ƒåŸç†)
- [ä»£ç è¯¦è§£](#ä»£ç è¯¦è§£)
- [æ‰©å±•æŒ‡å—](#æ‰©å±•æŒ‡å—)

---

## ä»€ä¹ˆæ˜¯ Agent

### æ™®é€š AI vs Agent

| æ™®é€š AI | Agent |
|---------|-------|
| ä½ é—®é—®é¢˜ï¼Œå®ƒå›ç­” | ä½ ç»™ä»»åŠ¡ï¼Œå®ƒè‡ªä¸»å®Œæˆ |
| åªèƒ½"è¯´" | èƒ½"è¯´"ä¹Ÿèƒ½"åš" |
| ä¸€é—®ä¸€ç­” | å¤šè½®å¾ªç¯æ‰§è¡Œ |

### Agent çš„æ ¸å¿ƒæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Agent                             â”‚
â”‚                                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚   â”‚  æ„ŸçŸ¥   â”‚ â†’  â”‚  æ€è€ƒ   â”‚ â†’  â”‚  è¡ŒåŠ¨   â”‚             â”‚
â”‚   â”‚Perceive â”‚    â”‚  Think  â”‚    â”‚   Act   â”‚             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚        â†‘                              â”‚                  â”‚
â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åé¦ˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                          â”‚
â”‚   æ„ŸçŸ¥: è¯»å–æ–‡ä»¶ã€æ¥æ”¶ç”¨æˆ·æŒ‡ä»¤ã€è·å–æ‰§è¡Œç»“æœ              â”‚
â”‚   æ€è€ƒ: LLM ç†è§£ã€æ¨ç†ã€å†³ç­–ï¼ˆClaude APIï¼‰               â”‚
â”‚   è¡ŒåŠ¨: è°ƒç”¨å·¥å…·å®Œæˆä»»åŠ¡                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Agent vs Skillï¼ˆå·¥ä½œæµï¼‰

- **Skill/å·¥ä½œæµ**: é¢„å®šä¹‰çš„å›ºå®šæ­¥éª¤ï¼ŒæŒ‰éƒ¨å°±ç­æ‰§è¡Œ
- **Agent**: æ ¹æ®å®é™…æƒ…å†µè‡ªä¸»å†³ç­–ï¼Œé‡åˆ°é—®é¢˜ä¼šè°ƒæ•´ç­–ç•¥

```
Skill:  æ­¥éª¤1 â†’ æ­¥éª¤2 â†’ æ­¥éª¤3 â†’ å®Œæˆï¼ˆå›ºå®šè·¯å¾„ï¼‰

Agent:  å¼€å§‹ â†’ åˆ†æ â†’ è·¯å¾„A â†’ å¤±è´¥ â†’ æ¢è·¯å¾„B â†’ æˆåŠŸï¼ˆåŠ¨æ€è°ƒæ•´ï¼‰
```

---

## é¡¹ç›®ç»“æ„

```
agent-api-autotest/
â”œâ”€â”€ .env                      # API Key é…ç½®
â”œâ”€â”€ requirements.txt          # Python ä¾èµ–
â”œâ”€â”€ api_test_agent.py         # ğŸ¤– Agent ä¸»ç¨‹åº
â”œâ”€â”€ swagger/
â”‚   â””â”€â”€ petstore.json         # ç¤ºä¾‹ Swagger æ–‡æ¡£
â”œâ”€â”€ tests/
â”‚   â”œâ”€â”€ conftest.py           # pytest é…ç½®
â”‚   â”œâ”€â”€ test_petstore.py      # Agent ç”Ÿæˆçš„æµ‹è¯•ç”¨ä¾‹
â”‚   â””â”€â”€ test_petstore_robust.py
â””â”€â”€ å­¦ä¹ ç¤ºä¾‹/
    â”œâ”€â”€ step1_basic.py        # åŸºç¡€ API è°ƒç”¨
    â”œâ”€â”€ step2_with_tools.py   # æ·»åŠ å·¥å…·
    â””â”€â”€ step3_agent_loop.py   # å®Œæ•´ Agent å¾ªç¯
```

---

## å¿«é€Ÿå¼€å§‹

### 1. ç¯å¢ƒå‡†å¤‡

```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼ˆå¯é€‰ï¼‰
python -m venv venv
source venv/bin/activate  # Windows: venv\Scripts\activate

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

### 2. é…ç½® API Key

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼š

```
ANTHROPIC_API_KEY=sk-ant-api03-xxxxxä½ çš„API Key
```

API Key è·å–åœ°å€: https://console.anthropic.com/

### 3. è¿è¡Œ Agent

```bash
python api_test_agent.py
```

### 4. è¾“å…¥æŒ‡ä»¤

```
ğŸ‘¤ è¯·è¾“å…¥æŒ‡ä»¤: è¯»å– swagger/petstore.jsonï¼Œä¸ºæ‰€æœ‰æ¥å£ç”Ÿæˆ pytest æµ‹è¯•ç”¨ä¾‹
```

---

## ä½¿ç”¨æ–¹æ³•

### äº¤äº’æ¨¡å¼

```bash
python api_test_agent.py
```

å¯ç”¨æŒ‡ä»¤ç¤ºä¾‹ï¼š

| æŒ‡ä»¤ | è¯´æ˜ |
|------|------|
| `è¯»å– swagger/xxx.jsonï¼Œç”Ÿæˆæµ‹è¯•ç”¨ä¾‹` | ä» Swagger ç”Ÿæˆæµ‹è¯• |
| `è¿è¡Œæµ‹è¯•` | æ‰§è¡Œ pytest |
| `è¿è¡Œæµ‹è¯•å¹¶ä¿®å¤å¤±è´¥çš„ç”¨ä¾‹` | æ‰§è¡Œæµ‹è¯• + è‡ªåŠ¨ä¿®å¤ |
| `åˆ—å‡º tests ç›®å½•çš„æ–‡ä»¶` | æŸ¥çœ‹å·²æœ‰æµ‹è¯• |
| `è¯»å– tests/test_xxx.py` | æŸ¥çœ‹æµ‹è¯•ä»£ç  |

### è„šæœ¬è°ƒç”¨

```python
from api_test_agent import run_agent

# å•æ¬¡ä»»åŠ¡
run_agent("è¯»å– swagger/petstore.jsonï¼Œä¸ºæ‰€æœ‰æ¥å£ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹")

# è¿ç»­ä»»åŠ¡
run_agent("è¿è¡Œæµ‹è¯•å¹¶ä¿®å¤æ‰€æœ‰å¤±è´¥çš„ç”¨ä¾‹")
```

### ä½¿ç”¨è‡ªå·±çš„ Swagger æ–‡æ¡£

1. å°†ä½ çš„ Swagger æ–‡æ¡£ï¼ˆJSON/YAMLï¼‰æ”¾å…¥ `swagger/` ç›®å½•
2. è¿è¡Œ Agent å¹¶æŒ‡å®šæ–‡ä»¶åï¼š

```
ğŸ‘¤ è¯·è¾“å…¥æŒ‡ä»¤: è¯»å– swagger/my-api.jsonï¼Œç”Ÿæˆæµ‹è¯•ç”¨ä¾‹
```

---

## æ ¸å¿ƒåŸç†

### Agent å·¥ä½œæµç¨‹

```
ç”¨æˆ·: "è¯»å– Swagger ç”Ÿæˆæµ‹è¯•"
           â”‚
           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Agent å¾ªç¯                                                â”‚
â”‚                                                          â”‚
â”‚  è½®æ¬¡1: Claude æ€è€ƒ â†’ "éœ€è¦å…ˆè¯»å– Swagger"                â”‚
â”‚         è°ƒç”¨ read_swagger å·¥å…·                            â”‚
â”‚         è·å¾—æ¥å£å®šä¹‰                                      â”‚
â”‚                    â”‚                                      â”‚
â”‚                    â–¼                                      â”‚
â”‚  è½®æ¬¡2: Claude æ€è€ƒ â†’ "æœ‰4ä¸ªæ¥å£ï¼Œç”Ÿæˆæµ‹è¯•ä»£ç "           â”‚
â”‚         è°ƒç”¨ write_test_file å·¥å…·                         â”‚
â”‚         æ–‡ä»¶å·²åˆ›å»º                                        â”‚
â”‚                    â”‚                                      â”‚
â”‚                    â–¼                                      â”‚
â”‚  è½®æ¬¡3: Claude æ€è€ƒ â†’ "è¿è¡Œæµ‹è¯•éªŒè¯"                      â”‚
â”‚         è°ƒç”¨ run_pytest å·¥å…·                              â”‚
â”‚         å‘ç°3ä¸ªå¤±è´¥                                       â”‚
â”‚                    â”‚                                      â”‚
â”‚                    â–¼                                      â”‚
â”‚  è½®æ¬¡4: Claude æ€è€ƒ â†’ "åˆ†æå¤±è´¥åŸå› ï¼Œä¿®æ”¹ä»£ç "            â”‚
â”‚         è°ƒç”¨ read_file + write_test_file å·¥å…·             â”‚
â”‚         ä»£ç å·²ä¿®å¤                                        â”‚
â”‚                    â”‚                                      â”‚
â”‚                    â–¼                                      â”‚
â”‚  è½®æ¬¡5: Claude æ€è€ƒ â†’ "å†æ¬¡è¿è¡Œæµ‹è¯•"                      â”‚
â”‚         è°ƒç”¨ run_pytest å·¥å…·                              â”‚
â”‚         å…¨éƒ¨é€šè¿‡ âœ“                                        â”‚
â”‚                    â”‚                                      â”‚
â”‚                    â–¼                                      â”‚
â”‚  è½®æ¬¡6: Claude â†’ "ä»»åŠ¡å®Œæˆï¼Œè¿”å›ç»“æœ"                     â”‚
â”‚         stop_reason = "end_turn"                          â”‚
â”‚         å¾ªç¯ç»“æŸ                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å·¥å…·å®šä¹‰

Agent é€šè¿‡"å·¥å…·"ä¸å¤–ç•Œäº¤äº’ã€‚æ¯ä¸ªå·¥å…·éœ€è¦å®šä¹‰ï¼š

```python
{
    "name": "å·¥å…·åç§°",
    "description": "å‘Šè¯‰ Claude è¿™ä¸ªå·¥å…·æ˜¯å¹²å˜›çš„",
    "input_schema": {
        "type": "object",
        "properties": {
            "å‚æ•°å": {
                "type": "string",
                "description": "å‚æ•°è¯´æ˜"
            }
        },
        "required": ["å¿…å¡«å‚æ•°"]
    }
}
```

### æœ¬é¡¹ç›®çš„å·¥å…·

| å·¥å…· | åŠŸèƒ½ | ä½¿ç”¨åœºæ™¯ |
|------|------|----------|
| `read_swagger` | è¯»å– Swagger/OpenAPI æ–‡æ¡£ | è·å–æ¥å£å®šä¹‰ |
| `write_test_file` | å†™å…¥æµ‹è¯•ä»£ç æ–‡ä»¶ | ç”Ÿæˆæµ‹è¯•ç”¨ä¾‹ |
| `run_pytest` | æ‰§è¡Œ pytest æµ‹è¯• | éªŒè¯æµ‹è¯•ç»“æœ |
| `read_file` | è¯»å–ä»»æ„æ–‡ä»¶ | æŸ¥çœ‹ä»£ç ã€é…ç½® |
| `send_http_request` | å‘é€ HTTP è¯·æ±‚ | è°ƒè¯•æ¥å£ |
| `list_files` | åˆ—å‡ºç›®å½•æ–‡ä»¶ | äº†è§£é¡¹ç›®ç»“æ„ |

---

## ä»£ç è¯¦è§£

### æ ¸å¿ƒä»£ç ç»“æ„ (api_test_agent.py)

```python
# 1. å®šä¹‰å·¥å…·
tools = [
    {"name": "read_swagger", ...},
    {"name": "write_test_file", ...},
    ...
]

# 2. å®ç°å·¥å…·å‡½æ•°
def read_swagger(file_path): ...
def write_test_file(file_name, content): ...
def run_pytest(test_file): ...

# 3. å·¥å…·æ‰§è¡Œå™¨
def execute_tool(name, input_data):
    if name == "read_swagger":
        return read_swagger(input_data["file_path"])
    elif name == "write_test_file":
        return write_test_file(input_data["file_name"], input_data["content"])
    ...

# 4. Agent ä¸»å¾ªç¯
def run_agent(user_message):
    messages = [{"role": "user", "content": user_message}]
    
    while True:
        # è°ƒç”¨ Claude API
        response = client.messages.create(
            model="claude-sonnet-4-20250514",
            tools=tools,
            messages=messages
        )
        
        # å¦‚æœ Claude ä¸éœ€è¦è°ƒç”¨å·¥å…·äº†ï¼Œç»“æŸ
        if response.stop_reason == "end_turn":
            break
        
        # å¤„ç†å·¥å…·è°ƒç”¨
        for block in response.content:
            if block.type == "tool_use":
                result = execute_tool(block.name, block.input)
                # æŠŠç»“æœå‘å›ç»™ Claude
                messages.append(...)
```

### æ¶ˆæ¯æµè½¬

```
messages = [
    {"role": "user", "content": "è¯»å– swagger ç”Ÿæˆæµ‹è¯•"},
    
    {"role": "assistant", "content": [
        {"type": "text", "text": "æˆ‘æ¥è¯»å–æ–‡æ¡£"},
        {"type": "tool_use", "name": "read_swagger", ...}
    ]},
    
    {"role": "user", "content": [
        {"type": "tool_result", "content": "Swagger å†…å®¹..."}
    ]},
    
    {"role": "assistant", "content": [
        {"type": "text", "text": "ç”Ÿæˆæµ‹è¯•ä»£ç "},
        {"type": "tool_use", "name": "write_test_file", ...}
    ]},
    
    ...
]
```

---

## æ‰©å±•æŒ‡å—

### æ·»åŠ æ–°å·¥å…·

1. åœ¨ `tools` åˆ—è¡¨ä¸­å®šä¹‰å·¥å…·ï¼š

```python
{
    "name": "my_new_tool",
    "description": "æè¿°è¿™ä¸ªå·¥å…·çš„åŠŸèƒ½",
    "input_schema": {
        "type": "object",
        "properties": {
            "param1": {"type": "string", "description": "å‚æ•°1è¯´æ˜"}
        },
        "required": ["param1"]
    }
}
```

2. å®ç°å·¥å…·å‡½æ•°ï¼š

```python
def my_new_tool(param1: str) -> str:
    # å®ç°é€»è¾‘
    return "æ‰§è¡Œç»“æœ"
```

3. åœ¨ `execute_tool` ä¸­æ³¨å†Œï¼š

```python
def execute_tool(name, input_data):
    ...
    elif name == "my_new_tool":
        return my_new_tool(input_data["param1"])
```

### å¸¸è§æ‰©å±•åœºæ™¯

| åœºæ™¯ | éœ€è¦æ·»åŠ çš„å·¥å…· |
|------|---------------|
| éœ€è¦æ•°æ®åº“æ“ä½œ | `query_database`, `insert_data` |
| éœ€è¦è®¤è¯ | `login`, `get_token` |
| éœ€è¦é€šçŸ¥ | `send_email`, `send_slack` |
| éœ€è¦ç‰ˆæœ¬æ§åˆ¶ | `git_commit`, `git_push` |

### ä¿®æ”¹ System Prompt

ç¼–è¾‘ `SYSTEM_PROMPT` å˜é‡å¯ä»¥æ”¹å˜ Agent çš„è¡Œä¸ºï¼š

```python
SYSTEM_PROMPT = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ¥å£è‡ªåŠ¨åŒ–æµ‹è¯• Agent...

# å¯ä»¥æ·»åŠ ï¼š
- ç‰¹å®šçš„æµ‹è¯•è§„èŒƒ
- ä»£ç é£æ ¼è¦æ±‚
- ä¸šåŠ¡ç›¸å…³çš„ä¸Šä¸‹æ–‡
"""
```

---

## ç›¸å…³èµ„æº

- [Anthropic API æ–‡æ¡£](https://docs.anthropic.com/)
- [Claude Tool Use æŒ‡å—](https://docs.anthropic.com/claude/docs/tool-use)
- [pytest å®˜æ–¹æ–‡æ¡£](https://docs.pytest.org/)

---

## License

MIT
